#!/usr/bin/env bash
# -*- mode: shell-script; sh-shell: bash; sh-basic-offset: 4; sh-indentation: 4; coding: utf-8 -*-
# shellcheck shell=bash

set -o nounset -o errexit -o errtrace -o pipefail
shopt -s inherit_errexit

function mycmd_launcher.set_mycmd_system_environment() {
    _MYCMD_LAUNCHER_SELF_FILE="${BASH_SOURCE[0]}"
    MYCMD_BIN_DIR=$(cd "$(dirname "${_MYCMD_LAUNCHER_SELF_FILE}")" &>/dev/null && pwd -P)
    readonly MYCMD_BIN_DIR
    export MYCMD_BIN_DIR

    if [[ -z "${MYCMD_SYSTEM_BASE_DIR-}" || ! -d "${MYCMD_SYSTEM_BASE_DIR}" ]]; then
        local -r system_base_dir_relative="${MYCMD_BIN_DIR}/../mycmd"

        if [[ ! -d "${system_base_dir_relative}" ]]; then
            echo >&2 "Cannot find MyCmd system library base directory in the standard location."
            exit 1
        fi

        if ! MYCMD_SYSTEM_BASE_DIR=$(cd "${system_base_dir_relative}" &>/dev/null && pwd -P); then
            echo >&2 "MYCMD_SYSTEM_BASE_DIR cannot be set."
            exit 1
        fi

        readonly MYCMD_SYSTEM_BASE_DIR
        export MYCMD_SYSTEM_BASE_DIR
    fi

    if [[ ! -e "${MYCMD_SYSTEM_BASE_DIR}/mycmd-lib" ]]; then
        echo >&2 "MYCMD_SYSTEM_BASE_DIR setting of ${MYCMD_SYSTEM_BASE_DIR} invalid, as required file mycmd-lib is missing."
        exit 1
    fi

    if [[ -z "${MYCMD_VENDOR_DIR-}" || ! -d "${MYCMD_VENDOR_DIR}" ]]; then
        local -r vendor_dir_relative="${MYCMD_BIN_DIR}/../vendor"

        if [[ ! -d "${vendor_dir_relative}" ]]; then
            echo >&2 "Cannot find MyCmd vendor library directory in the standard location."
            exit 1
        fi

        if ! MYCMD_VENDOR_DIR=$(cd "${vendor_dir_relative}" &>/dev/null && pwd -P); then
            echo >&2 "MYCMD_VENDOR_DIR cannot be set."
            exit 1
        fi

        readonly MYCMD_VENDOR_DIR
        export MYCMD_VENDOR_DIR
    fi
}

function mycmd_launcher.set_mycmd_user_environment() {
    if [[ -z "${MYCMD_USER_BASE_DIR-}" ]]; then
        MYCMD_USER_BASE_DIR="${HOME}/mycmd"
    fi

    if [[ ! -d "${MYCMD_USER_BASE_DIR}" ]]; then
        echo >&2 "Required MyCmd user library directory, '${MYCMD_USER_BASE_DIR}' not found."
        exit 1
    fi

    readonly MYCMD_USER_BASE_DIR
    export MYCMD_USER_BASE_DIR
}

# ------------------------------------------------------------------------------
# Set MYCMD_SYSTEM_BASE_DIR and MYCMD_USER_BASE_DIR
#
#   MYCMD_SYSTEM_BASE_DIR defaults to the mycmd directory that is parallel to
#   the bin directory that this mycmd script is in; have MYCMD_SYSTEM_BASE_DIR
#   set before launching to override this, however this directory must include
#   the mycmd-lib file that is included in the MyCmd distribution.
#
#   MYCMD_USER_BASE_DIR defaults to ~/mycmd; have MYCMD_USER_BASE_DIR set before
#   launching to override this.
#
# ------------------------------------------------------------------------------
# Validate MYCMD_SYSTEM_BASE_DIR setting and source MyCmd Base Library
mycmd_launcher.set_mycmd_system_environment
mycmd_launcher.set_mycmd_user_environment

# shellcheck source=./mycmd/mycmd-lib
source "${MYCMD_SYSTEM_BASE_DIR}/mycmd-lib" "${@}"

function mycmd_launcher.main() {
    # Manually run the startup deferreds for the launcher
    mycmd.run_startup_deferreds

    # shellcheck disable=SC2154
    mycmd.output "Successfully loaded ${#_MYCMD_COMMAND_GROUP_SOURCE_FILES[@]} command groups."
    # shellcheck disable=SC2154
    mycmd.output "Successfully loaded ${#_MYCMD_COMMAND_GROUP_VERSIONS[@]} command group short descriptions."
    # shellcheck disable=SC2154
    mycmd.output "Successfully loaded ${#_MYCMD_COMMAND_GROUP_SHORT_DESCS[@]} command group short descriptions."
    # shellcheck disable=SC2154
    mycmd.output "Successfully loaded ${#_MYCMD_COMMAND_GROUP_LONG_DESCS[@]} command group long descriptions."
    # shellcheck disable=SC2154
    mycmd.output "Successfully loaded ${#_MYCMD_COMMAND_SOURCE_FILES[@]} commands."

    mycmd.print_command_group_help "mycmd/project"
}

mycmd_launcher.main "${@}"
